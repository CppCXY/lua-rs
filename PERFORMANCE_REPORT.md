# luars æ€§èƒ½æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2024å¹´12æœˆ4æ—¥  
**å¯¹æ¯”ç‰ˆæœ¬**: luars vs Lua 5.4.6  
**æ€»è¿è¡Œæ—¶é—´**: luars 16.55s vs Lua 5.4 10.02s (65%)

---

## ğŸ”´ ç´§æ€¥ä¼˜åŒ–é¡¹ç›®ï¼ˆæ€§èƒ½å·®è· > 50%ï¼‰

### 1. é—­åŒ…è¿­ä»£å™¨ - **5% of Lua 5.4** âš ï¸ æœ€é«˜ä¼˜å…ˆçº§
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Closure iterator (100) | 16.67 K/s | 303.03 K/s | **5%** |

**åˆ†æ**: é—­åŒ…è¿­ä»£å™¨åœ¨ Lua ä¸­æå…¶å¸¸è§ï¼ˆio.lines, è‡ªå®šä¹‰è¿­ä»£å™¨ç­‰ï¼‰ï¼Œè¿™æ˜¯æœ€ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚

### 2. å…ƒæ–¹æ³•è°ƒç”¨ - **17-51%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| __index (function) | 5.22 M/s | 29.41 M/s | **18%** |
| __len metamethod | 5.50 M/s | 33.33 M/s | **17%** |
| __call metamethod | 17.10 M/s | 33.33 M/s | **51%** |
| __add metamethod | 2.91 M/s | 4.55 M/s | **64%** |

**åˆ†æ**: å…ƒæ–¹æ³•æŸ¥æ‰¾å’Œè°ƒç”¨å¼€é”€è¿‡å¤§ã€‚

### 3. pcall æˆåŠŸè·¯å¾„ - **15%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| pcall (success) | 2.49 M/s | 16.67 M/s | **15%** |
| assert (success) | 11.10 M/s | 50.00 M/s | **22%** |

**åˆ†æ**: pcall æˆåŠŸæ—¶ä¸åº”è¯¥æœ‰æ˜¾è‘—å¼€é”€ï¼Œå½“å‰å®ç°æœ‰é—®é¢˜ã€‚

### 4. vararg å¤„ç† - **18-40%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| select('#', ...) | 3.48 M/s | 19.23 M/s | **18%** |
| select(3, ...) | 3.35 M/s | 17.54 M/s | **19%** |
| table.unpack (5 values) | 4.91 M/s | 20.00 M/s | **25%** |
| Vararg passthrough | 12.63 M/s | 31.25 M/s | **40%** |

**åˆ†æ**: vararg çš„åˆ›å»ºã€è®¿é—®å’Œä¼ é€’éƒ½å¾ˆæ…¢ã€‚

### 5. è¿­ä»£å™¨é€šç”¨é—®é¢˜ - **37-39%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Multi-value iterator | 7.60 K/s | 20.62 K/s | **37%** |
| Custom stateless iter | 12.46 K/s | 31.65 K/s | **39%** |

### 6. å‡½æ•°è°ƒç”¨å¼€é”€ - **42%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Simple function call | 22.13 M/s | 52.63 M/s | **42%** |
| Returns as func args | 10.87 M/s | 25.00 M/s | **43%** |

### 7. OOP æ–¹æ³•è°ƒç”¨ - **32-33%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Method call (colon) | 3.88 M/s | 12.20 M/s | **32%** |
| Method call (dot) | 4.28 M/s | 13.51 M/s | **32%** |
| Inherited method call | 3.49 M/s | 11.11 M/s | **31%** |

### 8. å¾ªç¯æ§åˆ¶ - **51-53%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| While loop | 74.49 M/s | 140.85 M/s | **53%** |
| Repeat-until | 80.35 M/s | 158.73 M/s | **51%** |
| Nested loops | 134.23 M/s | 250.00 M/s | **54%** |

### 9. å˜é‡è®¿é—® - **53-60%**
| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Global var access | 38.34 M/s | 72.99 M/s | **53%** |
| Upvalue access | 81.64 M/s | 136.99 M/s | **60%** |

---

## ğŸŸ¡ ä¸­ç­‰å·®è·é¡¹ç›®ï¼ˆæ€§èƒ½å·®è· 30-50%ï¼‰

| æµ‹è¯• | luars | Lua 5.4 | æ¯”ç‡ |
|------|-------|---------|------|
| Local var access | 165 M/s | 238 M/s | 69% |
| Integer addition | 159 M/s | 238 M/s | 67% |
| Float multiplication | 158 M/s | 217 M/s | 73% |
| Table access | 97.93 M/s | 142.86 M/s | 69% |
| ipairs iteration | 24.56 K/s | 45.45 K/s | 54% |
| Upvalue read/write | 22.37 M/s | 40.00 M/s | 56% |
| Multiple upvalues | 18.58 M/s | 34.48 M/s | 54% |
| Nested closures | 22.27 M/s | 35.71 M/s | 62% |

---

## ğŸŸ¢ luars è¡¨ç°æ›´å¥½çš„é¡¹ç›®

| æµ‹è¯• | luars | Lua 5.4 | å€æ•° |
|------|-------|---------|------|
| table.sort (sorted) | 194 K/s | 8 K/s | **24x faster** |
| table.sort (reversed) | 35.6 K/s | 5.78 K/s | **6x faster** |
| Repeated yield | 3.06 M/s | 0.79 M/s | **4x faster** |
| pcall (error path) | 2.18 M/s | 0.55 M/s | **4x faster** |
| table.insert (end) | 21.27 M/s | 14.29 M/s | 1.5x faster |
| table.remove (end) | 26.81 M/s | 16.67 M/s | 1.6x faster |

---

## ä¼˜åŒ–è®¡åˆ’ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### Phase 1: æ ¸å¿ƒè°ƒç”¨è·¯å¾„ä¼˜åŒ–
1. [ ] é—­åŒ…è¿­ä»£å™¨ä¼˜åŒ–ï¼ˆ5% â†’ ç›®æ ‡ 60%+ï¼‰
2. [ ] pcall æˆåŠŸè·¯å¾„ä¼˜åŒ–ï¼ˆ15% â†’ ç›®æ ‡ 80%+ï¼‰
3. [ ] å…ƒæ–¹æ³•è°ƒç”¨ä¼˜åŒ–ï¼ˆ17% â†’ ç›®æ ‡ 60%+ï¼‰

### Phase 2: vararg å’Œå‡½æ•°è°ƒç”¨
4. [ ] select() å’Œ vararg å¤„ç†ä¼˜åŒ–
5. [ ] ç®€å•å‡½æ•°è°ƒç”¨å¼€é”€å‡å°‘
6. [ ] å¤šè¿”å›å€¼ä¼ é€’ä¼˜åŒ–

### Phase 3: å¾ªç¯å’Œå˜é‡è®¿é—®
7. [ ] while/repeat-until å¾ªç¯ä¼˜åŒ–
8. [ ] å…¨å±€å˜é‡è®¿é—®ä¼˜åŒ–
9. [ ] upvalue è®¿é—®ä¼˜åŒ–

### Phase 4: å…¶ä»–ä¼˜åŒ–
10. [ ] OOP æ–¹æ³•è°ƒç”¨ä¼˜åŒ–
11. [ ] è¿­ä»£å™¨é€šç”¨ä¼˜åŒ–
12. [ ] è¡¨è®¿é—®ä¼˜åŒ–

---

## æŠ€æœ¯ç¬”è®°

### å·²å®Œæˆçš„ä¼˜åŒ–
- [x] Return è¯­å¥å­—èŠ‚ç ä¼˜åŒ–ï¼ˆæ¶ˆé™¤å¤šä½™ MOVE æŒ‡ä»¤ï¼‰
- [x] TAILCALL å­—èŠ‚ç ä¿®å¤
- [x] `get_result_reg` è¾…åŠ©å‡½æ•°ç»Ÿä¸€å¯„å­˜å™¨åˆ†é…

### å¾…åˆ†æçš„é—®é¢˜
- é—­åŒ…è¿­ä»£å™¨ä¸ºä½•å¦‚æ­¤æ…¢ï¼Ÿéœ€è¦ profiling
- pcall çš„æˆåŠŸè·¯å¾„åœ¨åšä»€ä¹ˆé¢å¤–å·¥ä½œï¼Ÿ
- å…ƒæ–¹æ³•æŸ¥æ‰¾æ˜¯å¦æœ‰ç¼“å­˜ï¼Ÿ
