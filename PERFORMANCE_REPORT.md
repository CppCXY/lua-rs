# Lua-RS vs Native Lua æ€§èƒ½å¯¹æ¯”åˆ†ææŠ¥å‘Š

> **æ›´æ–°æ—¶é—´**: 2025-12-01
> **åˆ†æ”¯**: gc
> **ç›®çš„**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œä¸ºåç»­ä¼˜åŒ–æä¾›å‚è€ƒ

## æ¦‚è¿°

| æŒ‡æ ‡ | Native Lua | Lua-RS | æ¯”ç‡ |
|------|-----------|--------|------|
| **æ€»æ‰§è¡Œæ—¶é—´** | 11.80s | 80.18s | **6.8x æ…¢** |

---

## ğŸ”´ ä¸¥é‡æ€§èƒ½é—®é¢˜ (>5x å·®è·) - ä¼˜å…ˆçº§: é«˜

### 1. OOP æ–¹æ³•è°ƒç”¨ (~30x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Method call (colon) | 10,638 K/s | 350 K/s | **30x** |
| Method call (dot) | 11,628 K/s | 399 K/s | **29x** |
| Inherited method call | 10,000 K/s | 392 K/s | **25x** |
| Closure method call | 38,462 K/s | 466 K/s | **82x** |
| Prototype chain (3 levels) | 22,727 K/s | 429 K/s | **53x** |

**æ ¹å› åˆ†æ**: 
- æ–¹æ³•è°ƒç”¨æ¶‰åŠ `__index` å…ƒæ–¹æ³•æŸ¥æ‰¾
- æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦å¤šæ¬¡è¡¨æŸ¥æ‰¾
- å¯èƒ½å­˜åœ¨ä¸å¿…è¦çš„é—­åŒ…åˆ›å»ºæˆ–å€¼å¤åˆ¶

**ä¼˜åŒ–æ–¹å‘**:
- ä¼˜åŒ– `__index` å…ƒæ–¹æ³•çš„å¿«é€Ÿè·¯å¾„
- ç¼“å­˜æ–¹æ³•æŸ¥æ‰¾ç»“æœ
- å‡å°‘æ–¹æ³•è°ƒç”¨çš„å¼€é”€

---

### 2. è¿­ä»£å™¨ (~50-60x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Custom stateless iter | 24.88 K/s | 0.44 K/s | **57x** |
| Multi-value iterator | 16.92 K/s | 0.42 K/s | **40x** |
| Closure iterator (100) | 256.41 K/s | 4.03 K/s | **64x** |

**æ ¹å› åˆ†æ**:
- `TFORCALL` æŒ‡ä»¤å®ç°æ•ˆç‡ä½
- è¿­ä»£å™¨å‡½æ•°è°ƒç”¨å¼€é”€å¤§
- å¤šè¿”å›å€¼å¤„ç†æ€§èƒ½å·®

**ä¼˜åŒ–æ–¹å‘**:
- ä¼˜åŒ– `TFORCALL`/`TFORLOOP` æŒ‡ä»¤
- å‡å°‘è¿­ä»£å™¨å‡½æ•°è°ƒç”¨çš„å¼€é”€
- ä¼˜åŒ–å¤šè¿”å›å€¼å¤„ç†

---

### 3. åç¨‹åˆ›å»º (~9x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Create/resume/yield | 487.80 K/s | 56.13 K/s | **8.7x** |
| coroutine.wrap | 2,000 K/s | 73.75 K/s | **27x** |

**æ ¹å› åˆ†æ**:
- åç¨‹åˆ›å»ºæ—¶åˆ†é…è¿‡å¤šå†…å­˜
- åç¨‹çŠ¶æ€ç®¡ç†å¼€é”€å¤§

**ä¼˜åŒ–æ–¹å‘**:
- ä¼˜åŒ–åç¨‹çŠ¶æ€ç»“æ„
- å¤ç”¨åç¨‹æ ˆç©ºé—´

---

### 4. å¯¹è±¡åˆ›å»º (~10x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Object creation | 3,571 K/s | 359 K/s | **10x** |
| Inherited object creation | 2,000 K/s | 195 K/s | **10x** |
| Closure object creation | 1,667 K/s | 99 K/s | **17x** |

**æ ¹å› åˆ†æ**:
- è¡¨åˆ›å»ºå’Œå…ƒè¡¨è®¾ç½®å¼€é”€å¤§
- é—­åŒ…åˆ›å»ºæ•ˆç‡ä½

---

### 5. __call å…ƒæ–¹æ³• (~81x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| __call metamethod | 33.33 M/s | 0.41 M/s | **81x** |

**æ ¹å› åˆ†æ**:
- `__call` å…ƒæ–¹æ³•æŸ¥æ‰¾å’Œè°ƒç”¨è·¯å¾„æœªä¼˜åŒ–
- æ¯æ¬¡è°ƒç”¨éƒ½è¿›è¡Œå®Œæ•´çš„å…ƒæ–¹æ³•æŸ¥æ‰¾

**ä¼˜åŒ–æ–¹å‘**:
- ç¼“å­˜ `__call` å…ƒæ–¹æ³•
- ä¼˜åŒ–è¡¨çš„ `__call` è°ƒç”¨è·¯å¾„

---

### 6. Returns as func args (~101x æ…¢)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Returns as func args | 22.22 M/s | 0.22 M/s | **101x** |

**æ ¹å› åˆ†æ**:
- å°†å‡½æ•°è¿”å›å€¼ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°å‚æ•°æ—¶æ•ˆç‡æä½
- å¤šè¿”å›å€¼ä¼ é€’å¼€é”€å¤§

---

## ğŸŸ  ä¸­ç­‰æ€§èƒ½é—®é¢˜ (2-5x å·®è·) - ä¼˜å…ˆçº§: ä¸­

### 1. åŸºç¡€å¾ªç¯æ€§èƒ½
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| While loop | 123.46 M/s | 50.23 M/s | **2.5x** |
| Repeat-until | 140.85 M/s | 78.44 M/s | **1.8x** |
| Nested loops | 250 M/s | 138.58 M/s | **1.8x** |

**æ ¹å› åˆ†æ**:
- æŒ‡ä»¤è°ƒåº¦å¼€é”€ (match åˆ†å‘)
- æ¯æ¡æŒ‡ä»¤è¿”å›ä¸»å¾ªç¯çš„å¼€é”€

**ä¼˜åŒ–æ–¹å‘**:
- è€ƒè™‘è¶…çº§æŒ‡ä»¤åˆå¹¶å¸¸è§æŒ‡ä»¤åºåˆ—
- ä¼˜åŒ–ä¸»å¾ªç¯è°ƒåº¦

---

### 2. ipairs/pairs è¿­ä»£
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| ipairs (1000 items) | 33.56 K/s | 10.35 K/s | **3.2x** |
| pairs on array | 32.47 K/s | 10.45 K/s | **3.1x** |
| pairs on hash | 22.94 K/s | 9.98 K/s | **2.3x** |
| next() iteration | 23.20 K/s | 9.87 K/s | **2.4x** |

**ä¼˜åŒ–æ–¹å‘**:
- ä¼˜åŒ– `ipairs`/`pairs` çš„ C å‡½æ•°å®ç°
- å‡å°‘æ¯æ¬¡è¿­ä»£çš„å‡½æ•°è°ƒç”¨å¼€é”€

---

### 3. å…¨å±€å˜é‡è®¿é—®
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Global var access | 73.53 M/s | 28.93 M/s | **2.5x** |
| Global table field | 42.37 M/s | 19.38 M/s | **2.2x** |

**ä¼˜åŒ–æ–¹å‘**:
- ä¼˜åŒ– `GETTABUP`/`SETTABUP` æŒ‡ä»¤
- ä¼˜åŒ– `_ENV` è¡¨æŸ¥æ‰¾

---

### 4. å­—ç¬¦ä¸²æ“ä½œ
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| string.reverse | 7,143 K/s | 2,668 K/s | **2.7x** |
| string.rep | 2,174 K/s | 1,083 K/s | **2.0x** |
| string.format (complex) | 1,408 K/s | 668 K/s | **2.1x** |
| string.char | 11,111 K/s | 4,557 K/s | **2.4x** |

---

### 5. Upvalue æ“ä½œ
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Upvalue read/write | 45.45 M/s | 18.75 M/s | **2.4x** |
| Multiple upvalues | 32.26 M/s | 16.24 M/s | **2.0x** |

---

### 6. math.min/max
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| math.min/max | 18.05 M/s | 6.18 M/s | **2.9x** |

---

### 7. __index (function)
| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| __index (function) | 22.73 M/s | 3.62 M/s | **6.3x** |

---

## ğŸŸ¢ æ€§èƒ½æ¥è¿‘ (<2x å·®è·) - å¯æ¥å—

| æµ‹è¯•é¡¹ | Lua | Lua-RS | å·®è· |
|--------|-----|--------|------|
| Integer addition | 200 M/s | 137 M/s | 1.5x |
| Float multiplication | 200 M/s | 135 M/s | 1.5x |
| Local var access | 227 M/s | 131 M/s | 1.7x |
| Table insertion | 47.62 M/s | 41.90 M/s | 1.1x |
| Table access | 111 M/s | 61.74 M/s | 1.8x |
| string.upper/lower | ~4,500 K/s | ~6,200 K/s | **Lua-RS æ›´å¿«!** |
| string.byte | 20,000 K/s | 20,924 K/s | **Lua-RS æ›´å¿«!** |
| table.sort | ç›¸è¿‘ | ç›¸è¿‘ | ~1x |
| Integer division (//) | 78 M/s | 114 M/s | **Lua-RS æ›´å¿«!** |

---

## ğŸ”µ Lua-RS æ›´å¿«çš„é¡¹ç›®

| æµ‹è¯•é¡¹ | Lua | Lua-RS | Lua-RS ä¼˜åŠ¿ |
|--------|-----|--------|-------------|
| Integer division (//) | 78 M/s | 114 M/s | 1.5x æ›´å¿« |
| Repeated yield | 685 K/s | 2,997 K/s | 4.4x æ›´å¿« |
| pcall (error) | 508 K/s | 2,184 K/s | 4.3x æ›´å¿« |
| xpcall (error) | 431 K/s | 1,273 K/s | 3.0x æ›´å¿« |
| string.upper | 4,545 K/s | 6,716 K/s | 1.5x æ›´å¿« |
| table.move | 112 K/s | 163 K/s | 1.5x æ›´å¿« |

---

## ä¼˜åŒ–ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€ä¼˜å…ˆçº§ (å½±å“æœ€å¤§)
1. **OOP æ–¹æ³•è°ƒç”¨** - 30-82x å·®è·ï¼Œå½±å“æ‰€æœ‰é¢å‘å¯¹è±¡ä»£ç 
2. **è‡ªå®šä¹‰è¿­ä»£å™¨** - 40-64x å·®è·ï¼Œå½±å“ `for...in` å¾ªç¯
3. **__call å…ƒæ–¹æ³•** - 81x å·®è·

### ç¬¬äºŒä¼˜å…ˆçº§
4. **Returns as func args** - 101x å·®è·ï¼Œä½†ä½¿ç”¨åœºæ™¯ç›¸å¯¹è¾ƒå°‘
5. **åç¨‹åˆ›å»º** - 9-27x å·®è·
6. **å¯¹è±¡åˆ›å»º** - 10-17x å·®è·

### ç¬¬ä¸‰ä¼˜å…ˆçº§
7. **åŸºç¡€å¾ªç¯ (while/repeat)** - 1.8-2.5x å·®è·
8. **å…¨å±€å˜é‡è®¿é—®** - 2.2-2.5x å·®è·
9. **ipairs/pairs** - 2.3-3.2x å·®è·

---

## æ¶æ„å±‚é¢çš„ä¼˜åŒ–å»ºè®®

### 1. æ–¹æ³•è°ƒç”¨ä¼˜åŒ–
- å®ç°å†…è”ç¼“å­˜ (Inline Caching) åŠ é€Ÿé‡å¤çš„æ–¹æ³•æŸ¥æ‰¾
- å¯¹ `self:method()` æ¨¡å¼è¿›è¡Œç‰¹æ®Šä¼˜åŒ–

### 2. è¿­ä»£å™¨ä¼˜åŒ–
- ä¼˜åŒ– `TFORCALL` æŒ‡ä»¤ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
- è€ƒè™‘å¯¹ `ipairs`/`pairs` è¿›è¡Œç‰¹æ®Šå¤„ç†

### 3. å‡½æ•°è°ƒç”¨ä¼˜åŒ–
- å‡å°‘å‡½æ•°è°ƒç”¨å¸§çš„åˆ›å»ºå¼€é”€
- ä¼˜åŒ–å¤šè¿”å›å€¼ä¼ é€’

### 4. å¾ªç¯ä¼˜åŒ–
- å®ç°è¶…çº§æŒ‡ä»¤ï¼Œåˆå¹¶å¸¸è§æŒ‡ä»¤åºåˆ—
- è€ƒè™‘å¾ªç¯ä¸å˜ä»£ç å¤–æ

### 5. å…ƒæ–¹æ³•ä¼˜åŒ–
- ç¼“å­˜å…ƒæ–¹æ³•æŸ¥æ‰¾ç»“æœ
- å¯¹å¸¸ç”¨å…ƒæ–¹æ³• (`__index`, `__call`) å®ç°å¿«é€Ÿè·¯å¾„

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025-12-01*
*åŸºå‡†æµ‹è¯•è¿­ä»£æ¬¡æ•°: è§å„æµ‹è¯•é¡¹*
