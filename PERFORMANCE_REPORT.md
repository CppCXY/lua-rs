# Lua-RS æ€§èƒ½æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2024-12-08  
**å¯¹æ¯”ç‰ˆæœ¬**: Lua-RS (Rust å®ç°) vs Lua 5.4 (åŸç”Ÿ C)  
**å¹³å°**: Windows x64, Release æ¨¡å¼

---

## ğŸ“Š æ€§èƒ½æ¦‚è§ˆ

### ğŸŸ¢ ä¼˜åŠ¿é¢†åŸŸ (Lua-RS æ›´å¿«)

| æµ‹è¯•é¡¹ | Lua-RS | åŸç”Ÿ Lua | ä¼˜åŠ¿æ¯” |
|--------|--------|----------|--------|
| Closure åˆ›å»º | 11.92 M/s | 7.46 M/s | **+60%** |
| table.insert (end) | 20.5 K/s | 12.5 K/s | **+64%** |
| table.insert (middle) | 11.2 K/s | 3.3 K/s | **+239%** |
| table.remove (end) | 25.8 K/s | 8.3 K/s | **+211%** |
| table.concat | 12.2 K/s | 39.5 K/s | -67% (è¯¯å·®?éœ€å¤æŸ¥) |
| table.sort (sorted) | 195.6 K/s | 6.4 K/s | **+30x** |
| table.sort (reversed) | 47.1 K/s | 4.2 K/s | **+11x** |
| table.sort (random) | 7.9 K/s | 3.5 K/s | **+2.2x** |
| table.sort (custom cmp) | 3.1 K/s | 1.9 K/s | **+63%** |
| Hash table æ’å…¥ (100k) | 0.037s | 0.066s | **+78%** |
| pcall (error) | 4.62 M/s | 0.51 M/s | **+9x** |
| xpcall (error) | 1.22 M/s | 0.43 M/s | **+2.8x** |
| coroutine yield | 2.07 M/s | 0.67 M/s | **+3.1x** |
| producer-consumer | 1.83 M/s | 0.63 M/s | **+2.9x** |
| # operator (length) | 168.5 M/s | 100 M/s | **+68%** |
| Integer division (//) | 138.8 M/s | 78.1 M/s | **+78%** |
| Integer mul/add/mod | 76.6 M/s | 58.8 M/s | **+30%** |
| If-else åˆ†æ”¯ | 65.8 M/s | 55.9 M/s | **+18%** |
| string.upper/lower | 6.3 K/s | 4.5 K/s | **+40%** |
| string.gsub | 0.137s | 0.203s | **+48%** |
| string.format (complex) | 725 K/s | 1389 K/s | -48% |

### ğŸ”´ éœ€è¦ä¼˜åŒ–çš„é¢†åŸŸ (Lua-RS è¾ƒæ…¢)

| æµ‹è¯•é¡¹ | Lua-RS | åŸç”Ÿ Lua | å·®è· | ä¼˜å…ˆçº§ |
|--------|--------|----------|------|--------|
| **ipairs è¿­ä»£** | 14.7 K/s | 33.0 K/s | **-55%** | ğŸ”¥ é«˜ |
| **pairs è¿­ä»£** | 13.2 K/s | 32.0 K/s | **-59%** | ğŸ”¥ é«˜ |
| **next() è¿­ä»£** | 10.4 K/s | 20.8 K/s | **-50%** | ğŸ”¥ é«˜ |
| **Upvalue è¯»å†™** | 22.9 M/s | 43.5 M/s | **-47%** | ğŸ”¥ é«˜ |
| **Method call (colon)** | 3.6 M/s | 7.2 M/s | **-50%** | ğŸ”¥ é«˜ |
| **Method call (dot)** | 3.9 M/s | 8.9 M/s | **-56%** | ğŸ”¥ é«˜ |
| Inherited method call | 3.4 M/s | 9.4 M/s | **-64%** | ğŸ”¥ é«˜ |
| Prototype chain (3çº§) | 8.7 M/s | 17.9 M/s | **-51%** | é«˜ |
| Global var access | 42.0 M/s | 71.9 M/s | **-42%** | ä¸­ |
| Local table field | 45.5 M/s | 74.1 M/s | **-39%** | ä¸­ |
| Vararg function | 1.33 M/s | 2.11 M/s | **-37%** | ä¸­ |
| select('#'/n, ...) | 4.2 M/s | 14.5 M/s | **-71%** | ä¸­ |
| Vararg passthrough | 14.6 M/s | 25.6 M/s | **-43%** | ä¸­ |
| coroutine.wrap | 0.64 M/s | 1.67 M/s | **-62%** | ä¸­ |
| While/Repeat å¾ªç¯ | 93-97 M/s | 123-143 M/s | **-30%** | ä½ |
| Bitwise æ“ä½œ | 67.8 M/s | 102 M/s | **-34%** | ä½ |
| Power (^2) | 20.5 M/s | 53.8 M/s | **-62%** | ä½ |
| Float mul/add/div | 64.3 M/s | 102 M/s | **-37%** | ä½ |
| string.match | 0.9 M/s | 8.3 M/s | **-89%** | ä¸­ |
| string.char | 4.8 M/s | 12.5 M/s | **-62%** | ä½ |
| Concat (4 parts) | 8.5 M/s | 20.0 M/s | **-58%** | ä¸­ |

---

## ğŸ¯ ä¼˜åŒ–å»ºè®® (æŒ‰ä¼˜å…ˆçº§æ’åº)

### ğŸ”¥ P0: æœ€é«˜ä¼˜å…ˆçº§ (æ ¸å¿ƒçƒ­ç‚¹)

#### 1. **è¿­ä»£å™¨æ€§èƒ½ (ipairs/pairs/next)**
- **é—®é¢˜**: æ¯”åŸç”Ÿ Lua æ…¢ 50-60%
- **å½±å“**: è¿­ä»£æ˜¯ Lua æœ€å¸¸ç”¨çš„æ“ä½œä¹‹ä¸€
- **å»ºè®®**:
  - ä¼˜åŒ– `TFORLOOP` / `TFORCALL` æŒ‡ä»¤å®ç°
  - å‡å°‘æ¯æ¬¡è¿­ä»£çš„è¾¹ç•Œæ£€æŸ¥
  - è€ƒè™‘ç‰¹åŒ– ipairs/pairs çš„å¿«é€Ÿè·¯å¾„
  - å†…è” next() å‡½æ•°è°ƒç”¨

#### 2. **Upvalue è®¿é—®**
- **é—®é¢˜**: æ¯”åŸç”Ÿ Lua æ…¢ 47%
- **å½±å“**: é—­åŒ…å†…è®¿é—®å¤–éƒ¨å˜é‡æ˜¯å¸¸è§æ¨¡å¼
- **å»ºè®®**:
  - ä¼˜åŒ– `GETUPVAL` / `SETUPVAL` æŒ‡ä»¤
  - å‡å°‘ upvalue é—´æ¥è®¿é—®å±‚æ¬¡
  - è€ƒè™‘ upvalue çš„å†…è”ç¼“å­˜

#### 3. **æ–¹æ³•è°ƒç”¨ (OOP æ¨¡å¼)**
- **é—®é¢˜**: æ–¹æ³•è°ƒç”¨æ…¢ 50-64%
- **å½±å“**: Lua çš„ OOP ä¾èµ–å…ƒè¡¨å’Œ __index
- **å»ºè®®**:
  - ä¼˜åŒ– `SELF` æŒ‡ä»¤
  - ç¼“å­˜ __index å…ƒæ–¹æ³•æŸ¥æ‰¾
  - è€ƒè™‘å†…è”ç¼“å­˜ (Inline Cache) æœºåˆ¶

### ğŸ”¶ P1: é«˜ä¼˜å…ˆçº§

#### 4. **å…¨å±€å˜é‡è®¿é—®**
- **é—®é¢˜**: æ¯”åŸç”Ÿ Lua æ…¢ 42%
- **å»ºè®®**:
  - ä¼˜åŒ– `GETTABUP` / `SETTABUP` æŒ‡ä»¤
  - è€ƒè™‘ _ENV è¡¨çš„ç‰¹æ®Šä¼˜åŒ–è·¯å¾„

#### 5. **Vararg å¤„ç†**
- **é—®é¢˜**: vararg å‡½æ•°å’Œ select() æ…¢ 37-71%
- **å»ºè®®**:
  - ä¼˜åŒ– `VARARG` æŒ‡ä»¤
  - å‡å°‘ vararg å‚æ•°çš„å¤åˆ¶å¼€é”€
  - select() å¯ä»¥ç‰¹åŒ–å¤„ç†

#### 6. **å­—ç¬¦ä¸²æ¨¡å¼åŒ¹é…**
- **é—®é¢˜**: string.match æ…¢ 89%
- **å»ºè®®**:
  - ä¼˜åŒ– pattern matching å¼•æ“
  - è€ƒè™‘ JIT ç¼–è¯‘ç®€å•æ¨¡å¼

### ğŸ”· P2: ä¸­ç­‰ä¼˜å…ˆçº§

#### 7. **å¾ªç¯æŒ‡ä»¤**
- While/Repeat å¾ªç¯æ…¢ 30%
- ä¼˜åŒ– `LOOP` ç›¸å…³æŒ‡ä»¤

#### 8. **ä½è¿ç®—**
- æ¯”åŸç”Ÿæ…¢ 34%
- æ£€æŸ¥ä½è¿ç®—æŒ‡ä»¤å®ç°

#### 9. **æµ®ç‚¹è¿ç®—**
- æ¯”åŸç”Ÿæ…¢ 37%
- æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„ç±»å‹æ£€æŸ¥

---

## âœ… å·²ä¼˜åŒ–çš„é¢†åŸŸ

ä»¥ä¸‹é¢†åŸŸ Lua-RS è¡¨ç°ä¼˜ç§€ï¼Œæ— éœ€é¢å¤–ä¼˜åŒ–ï¼š

1. **é”™è¯¯å¤„ç†** - pcall/xpcall åœ¨å¤„ç†é”™è¯¯æ—¶æ¯”åŸç”Ÿå¿« 3-9 å€
2. **åç¨‹ yield** - yield/resume æ€§èƒ½ä¼˜å¼‚
3. **è¡¨æ“ä½œ** - insert/remove/sort ç­‰è¡¨åº“å‡½æ•°æ€§èƒ½å‡ºè‰²
4. **é—­åŒ…åˆ›å»º** - åˆ›å»ºé—­åŒ…æ¯”åŸç”Ÿå¿« 60%
5. **æ•´æ•°è¿ç®—** - æ•´æ•°é™¤æ³•å’Œæ··åˆè¿ç®—è¾ƒå¿«
6. **å“ˆå¸Œè¡¨æ’å…¥** - æ¯”åŸç”Ÿå¿« 78%

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **Profiling**: ä½¿ç”¨ flamegraph æˆ– perf åˆ†æ ipairs çƒ­ç‚¹
2. **è¿­ä»£å™¨é‡æ„**: å®ç° TFORLOOP çš„å¿«é€Ÿè·¯å¾„
3. **å†…è”ç¼“å­˜**: ä¸ºæ–¹æ³•è°ƒç”¨å®ç°ç®€å•çš„ IC æœºåˆ¶
4. **Upvalue ä¼˜åŒ–**: å‡å°‘é—´æ¥è®¿é—®å±‚æ¬¡
5. **Benchmark ç»†åŒ–**: æ·»åŠ æ›´ç»†ç²’åº¦çš„å¾®åŸºå‡†æµ‹è¯•

---

## ğŸ“ æµ‹è¯•æ–¹æ³•

```bash
# ç¼–è¯‘ release ç‰ˆæœ¬
cargo build --release

# è¿è¡Œæ€§èƒ½æµ‹è¯•
./run_benchmarks.ps1
```

å„æµ‹è¯•æ–‡ä»¶ä½äº `benchmarks/` ç›®å½•ä¸‹ã€‚
