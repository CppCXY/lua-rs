<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lua WASM - ç±»å‹è½¬æ¢ç¤ºä¾‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .result {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .test-case {
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .test-case h4 {
            margin-top: 0;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Lua WASM ç±»å‹è½¬æ¢ç¤ºä¾‹</h1>

    <div class="section">
        <h2>ğŸ“– è¯´æ˜</h2>
        <p>è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† Lua å’Œ JavaScript ä¹‹é—´çš„ç±»å‹è½¬æ¢åŠŸèƒ½:</p>
        <ul>
            <li><strong>åŸºæœ¬ç±»å‹</strong>: nil, boolean, number, string</li>
            <li><strong>å¤æ‚ç±»å‹</strong>: table (æ•°ç»„/å¯¹è±¡), åµŒå¥—ç»“æ„</li>
            <li><strong>ç‰¹æ®Šå¤„ç†</strong>: å¾ªç¯å¼•ç”¨æ£€æµ‹, é€’å½’æ·±åº¦é™åˆ¶</li>
        </ul>
    </div>

    <div class="section">
        <h2>ğŸ”„ Lua â†’ JavaScript è½¬æ¢</h2>
        
        <div class="test-grid">
            <div class="test-case">
                <h4>åŸºæœ¬ç±»å‹</h4>
                <button onclick="testBasicTypes()">è¿è¡Œæµ‹è¯•</button>
                <div id="basic-result"></div>
            </div>

            <div class="test-case">
                <h4>æ•°ç»„</h4>
                <button onclick="testArrays()">è¿è¡Œæµ‹è¯•</button>
                <div id="array-result"></div>
            </div>

            <div class="test-case">
                <h4>å¯¹è±¡</h4>
                <button onclick="testObjects()">è¿è¡Œæµ‹è¯•</button>
                <div id="object-result"></div>
            </div>

            <div class="test-case">
                <h4>åµŒå¥—ç»“æ„</h4>
                <button onclick="testNested()">è¿è¡Œæµ‹è¯•</button>
                <div id="nested-result"></div>
            </div>

            <div class="test-case">
                <h4>æ··åˆç±»å‹</h4>
                <button onclick="testMixed()">è¿è¡Œæµ‹è¯•</button>
                <div id="mixed-result"></div>
            </div>

            <div class="test-case">
                <h4>JSON å¯¼å‡º</h4>
                <button onclick="testJsonExport()">è¿è¡Œæµ‹è¯•</button>
                <div id="json-result"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ”„ JavaScript â†’ Lua è½¬æ¢</h2>
        
        <div class="test-grid">
            <div class="test-case">
                <h4>è®¾ç½®åŸºæœ¬å€¼</h4>
                <button onclick="testSetBasic()">è¿è¡Œæµ‹è¯•</button>
                <div id="set-basic-result"></div>
            </div>

            <div class="test-case">
                <h4>è®¾ç½®æ•°ç»„</h4>
                <button onclick="testSetArray()">è¿è¡Œæµ‹è¯•</button>
                <div id="set-array-result"></div>
            </div>

            <div class="test-case">
                <h4>è®¾ç½®å¯¹è±¡</h4>
                <button onclick="testSetObject()">è¿è¡Œæµ‹è¯•</button>
                <div id="set-object-result"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ® äº¤äº’å¼æµ‹è¯•</h2>
        <textarea id="lua-code" rows="8" style="width: 100%; font-family: monospace; padding: 10px;">
-- è¾“å…¥ Lua ä»£ç 
return {
    name = "æµ‹è¯•",
    data = {1, 2, 3, 4, 5},
    nested = {
        a = true,
        b = false,
        c = nil
    }
}
        </textarea>
        <br>
        <button onclick="runCustomCode()">æ‰§è¡Œä»£ç </button>
        <button onclick="clearResult()">æ¸…é™¤ç»“æœ</button>
        <div id="custom-result"></div>
    </div>

    <script type="module">
        let lua;
        let isLoaded = false;

        // åˆå§‹åŒ– WASM æ¨¡å—
        async function init() {
            try {
                // æ³¨æ„: éœ€è¦å…ˆç¼–è¯‘ WASM æ¨¡å—
                // wasm-pack build --target web
                const { default: init, LuaWasm } = await import('./pkg/luars_wasm.js');
                await init();
                lua = new LuaWasm();
                isLoaded = true;
                showStatus('âœ… Lua WASM å·²åŠ è½½', 'success');
            } catch (e) {
                showStatus('âŒ åŠ è½½å¤±è´¥: ' + e.message, 'error');
                console.error(e);
            }
        }

        function showStatus(message, type) {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'error' : 'result';
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 3000);
        }

        function showResult(elementId, content) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = content;
        }

        // æµ‹è¯•å‡½æ•°
        window.testBasicTypes = async function() {
            if (!isLoaded) return showStatus('è¯·å…ˆåŠ è½½ WASM æ¨¡å—', 'error');
            
            try {
                const tests = [
                    { code: 'return nil', desc: 'nil â†’ null' },
                    { code: 'return true', desc: 'true â†’ true' },
                    { code: 'return 42', desc: '42 â†’ 42' },
                    { code: 'return 3.14', desc: '3.14 â†’ 3.14' },
                    { code: 'return "hello"', desc: '"hello" â†’ "hello"' }
                ];

                let result = '<div class="code-block">';
                for (const test of tests) {
                    const value = lua.eval(test.code.replace('return ', ''));
                    result += `${test.desc}: ${JSON.stringify(value)}<br>`;
                }
                result += '</div>';
                showResult('basic-result', result);
            } catch (e) {
                showResult('basic-result', `<div class="error">${e}</div>`);
            }
        };

        window.testArrays = function() {
            if (!isLoaded) return;
            
            try {
                const arr = lua.eval('{1, 2, 3, 4, 5}');
                showResult('array-result', 
                    `<div class="code-block">Lua: {1, 2, 3, 4, 5}<br>JS: ${JSON.stringify(arr)}</div>`);
            } catch (e) {
                showResult('array-result', `<div class="error">${e}</div>`);
            }
        };

        window.testObjects = function() {
            if (!isLoaded) return;
            
            try {
                const obj = lua.eval('{name = "John", age = 30}');
                showResult('object-result', 
                    `<div class="code-block">Lua: {name = "John", age = 30}<br>JS: ${JSON.stringify(obj)}</div>`);
            } catch (e) {
                showResult('object-result', `<div class="error">${e}</div>`);
            }
        };

        window.testNested = function() {
            if (!isLoaded) return;
            
            try {
                const nested = lua.eval('{a = {b = {c = 123}}}');
                showResult('nested-result', 
                    `<div class="code-block">åµŒå¥—å¯¹è±¡:<br>${JSON.stringify(nested, null, 2)}</div>`);
            } catch (e) {
                showResult('nested-result', `<div class="error">${e}</div>`);
            }
        };

        window.testMixed = function() {
            if (!isLoaded) return;
            
            try {
                const mixed = lua.eval('{1, 2, x = "hello", y = true}');
                showResult('mixed-result', 
                    `<div class="code-block">æ··åˆè¡¨:<br>${JSON.stringify(mixed, null, 2)}</div>`);
            } catch (e) {
                showResult('mixed-result', `<div class="error">${e}</div>`);
            }
        };

        window.testJsonExport = function() {
            if (!isLoaded) return;
            
            try {
                const json = lua.evalJson('{data = {1, 2, 3}, meta = {version = 1}}');
                showResult('json-result', 
                    `<div class="code-block">JSON å­—ç¬¦ä¸²:<br><pre>${json}</pre></div>`);
            } catch (e) {
                showResult('json-result', `<div class="error">${e}</div>`);
            }
        };

        window.testSetBasic = function() {
            if (!isLoaded) return;
            
            try {
                lua.setGlobal('myNumber', 123);
                lua.setGlobal('myString', 'test');
                const num = lua.getGlobal('myNumber');
                const str = lua.getGlobal('myString');
                showResult('set-basic-result', 
                    `<div class="code-block">è®¾ç½®: myNumber=123, myString="test"<br>è¯»å–: ${num}, "${str}"</div>`);
            } catch (e) {
                showResult('set-basic-result', `<div class="error">${e}</div>`);
            }
        };

        window.testSetArray = function() {
            if (!isLoaded) return;
            
            try {
                lua.setGlobal('myArray', [1, 2, 3, 4, 5]);
                const result = lua.execute('return #myArray');
                showResult('set-array-result', 
                    `<div class="code-block">è®¾ç½®æ•°ç»„ [1,2,3,4,5]<br>Lua ä¸­é•¿åº¦: ${result}</div>`);
            } catch (e) {
                showResult('set-array-result', `<div class="error">${e}</div>`);
            }
        };

        window.testSetObject = function() {
            if (!isLoaded) return;
            
            try {
                lua.setGlobal('myObj', {name: 'Alice', age: 25});
                const name = lua.execute('return myObj.name');
                showResult('set-object-result', 
                    `<div class="code-block">è®¾ç½®å¯¹è±¡ {name: 'Alice', age: 25}<br>è¯»å– name: "${name}"</div>`);
            } catch (e) {
                showResult('set-object-result', `<div class="error">${e}</div>`);
            }
        };

        window.runCustomCode = function() {
            if (!isLoaded) return;
            
            const code = document.getElementById('lua-code').value;
            try {
                const result = lua.execute(code);
                showResult('custom-result', 
                    `<div class="result"><strong>æ‰§è¡ŒæˆåŠŸ</strong><br><pre>${JSON.stringify(result, null, 2)}</pre></div>`);
            } catch (e) {
                showResult('custom-result', 
                    `<div class="error"><strong>æ‰§è¡Œé”™è¯¯</strong><br>${e}</div>`);
            }
        };

        window.clearResult = function() {
            showResult('custom-result', '');
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>

    <div class="section">
        <h2>ğŸ“ æ³¨æ„äº‹é¡¹</h2>
        <ul>
            <li>éœ€è¦å…ˆä½¿ç”¨ <code>wasm-pack build --target web</code> ç¼–è¯‘ WASM æ¨¡å—</li>
            <li>Lua æ•°ç»„ç´¢å¼•ä» 1 å¼€å§‹,è½¬æ¢ä¸º JS æ•°ç»„æ—¶ä¼šè‡ªåŠ¨è°ƒæ•´</li>
            <li>å¾ªç¯å¼•ç”¨ä¼šè¢«æ£€æµ‹å¹¶æ˜¾ç¤ºä¸º <code>"[Circular Reference]"</code></li>
            <li>æœ€å¤§é€’å½’æ·±åº¦ä¸º 100 å±‚</li>
            <li>JS çš„ <code>undefined</code> å’Œ <code>null</code> éƒ½è½¬æ¢ä¸º Lua çš„ <code>nil</code></li>
            <li>å½“å‰ç‰ˆæœ¬æš‚ä¸æ”¯æŒ JS å‡½æ•°åˆ° Lua å‡½æ•°çš„è½¬æ¢</li>
        </ul>
    </div>
</body>
</html>
